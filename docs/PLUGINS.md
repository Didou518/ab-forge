# Guide des Plugins

Guide complet du syst√®me de plugins du AB Forge Build Tool.

## üìã Table des mati√®res

- [Vue d'ensemble](#vue-densemble)
- [Architecture des plugins](#architecture-des-plugins)
- [Plugins disponibles](#plugins-disponibles)
- [Configuration](#configuration)
- [Utilisation des placeholders](#utilisation-des-placeholders)
- [Cr√©ation de plugins personnalis√©s](#cr√©ation-de-plugins-personnalis√©s)
- [Exemples pratiques](#exemples-pratiques)

## Vue d'ensemble

Le syst√®me de plugins permet de traiter diff√©rents types de fichiers et d'int√©grer leur contenu dans vos fichiers JavaScript principaux. Chaque plugin est sp√©cialis√© dans un type de fichier sp√©cifique et peut √™tre configur√© individuellement.

### Fonctionnalit√©s principales

- ‚úÖ **6 plugins int√©gr√©s** : CSS, HTML, JavaScript, SVG, JSON, JPG
- ‚úÖ **Configuration flexible** : Options personnalisables par plugin
- ‚úÖ **Gestion d'erreurs robuste** : Messages d'erreur clairs et informatifs
- ‚úÖ **Architecture modulaire** : Facilement extensible
- ‚úÖ **Performance optimis√©e** : Cache intelligent et traitement asynchrone

## Architecture des plugins

### Structure g√©n√©rale

```
src/plugins/
‚îú‚îÄ‚îÄ index.js              # Registre central des plugins
‚îú‚îÄ‚îÄ base/
‚îÇ   ‚îî‚îÄ‚îÄ BasePlugin.js     # Classe de base pour nouveaux plugins
‚îú‚îÄ‚îÄ css/index.js          # Plugin CSS avec PostCSS
‚îú‚îÄ‚îÄ html/index.js         # Plugin HTML avec minification
‚îú‚îÄ‚îÄ js/index.js           # Plugin JavaScript pour inclusion
‚îú‚îÄ‚îÄ svg/index.js          # Plugin SVG avec SVGO
‚îú‚îÄ‚îÄ json/index.js         # Plugin JSON avec validation
‚îî‚îÄ‚îÄ jpg/index.js          # Plugin JPG avec conversion base64
```

### Flux de traitement

1. **D√©couverte** : Scan des fichiers dans le r√©pertoire `src/`
2. **Filtrage** : Exclusion des fichiers cach√©s et sans extension
3. **Traitement** : Application du plugin correspondant √† l'extension
4. **Remplacement** : Substitution des placeholders par le contenu trait√©
5. **Int√©gration** : Injection du contenu dans le fichier principal

## Plugins disponibles

### üé® CSS Plugin

**Extension** : `.css`
**Technologie** : PostCSS
**Fichier** : `src/plugins/css/index.js`

#### Fonctionnalit√©s

- **Nesting CSS** : Support de la syntaxe imbriqu√©e
- **Autoprefixer** : Ajout automatique des pr√©fixes navigateurs
- **Minification** : Compression avec cssnano
- **Validation** : V√©rification de la syntaxe CSS

#### Configuration

```javascript
CONFIG.PLUGINS.CSS = {
  minify: true,           // Minification CSS
  autoprefixer: true,     // Pr√©fixes navigateurs
  nesting: true          // Support du nesting
}
```

#### Exemple d'utilisation

```javascript
// Dans votre fichier principal
const styles = `{{css/main}}`

// Remplace par le contenu trait√© de src/css/main.css
```

### üåê HTML Plugin

**Extension** : `.html`
**Technologie** : html-minifier
**Fichier** : `src/plugins/html/index.js`

#### Fonctionnalit√©s

- **Minification compl√®te** : Compression HTML optimis√©e
- **Suppression des commentaires** : Nettoyage automatique
- **Compression des espaces** : R√©duction de la taille
- **Minification inline** : CSS et JavaScript inline optimis√©s

#### Configuration

```javascript
CONFIG.PLUGINS.HTML = {
  minify: true,                    // Minification HTML
  removeComments: true,            // Suppression des commentaires
  removeAttributeQuotes: true,     // Suppression des guillemets
  collapseWhitespace: true,         // Compression des espaces
  collapseInlineTagWhitespace: true,
  minifyCSS: true,                 // Minification CSS inline
  minifyJS: true,                  // Minification JS inline
  removeRedundantAttributes: true,
  removeEmptyAttributes: true
}
```

#### Exemple d'utilisation

```javascript
// Dans votre fichier principal
const template = `{{html/header}}`

// Remplace par le contenu minifi√© de src/html/header.html
```

### üìú JavaScript Plugin

**Extension** : `.js`
**Technologie** : fs.promises
**Fichier** : `src/plugins/js/index.js`

#### Fonctionnalit√©s

- **Inclusion de fichiers** : Int√©gration de modules JavaScript
- **Commentaires de debug** : Ajout optionnel de commentaires
- **S√©parateurs** : Ajout de s√©parateurs entre fichiers
- **Validation** : V√©rification de l'existence des fichiers

#### Configuration

```javascript
CONFIG.PLUGINS.JS = {
  addDebugComments: false,  // Commentaires de debug
  addSeparators: false      // S√©parateurs entre fichiers
}
```

#### Exemple d'utilisation

```javascript
// Dans votre fichier principal
const utils = `{{js/helper}}`
const api = `{{js/apiClient}}`

// Remplace par le contenu de src/js/helper.js et src/js/apiClient.js
```

### üéØ SVG Plugin

**Extension** : `.svg`
**Technologie** : SVGO
**Fichier** : `src/plugins/svg/index.js`

#### Fonctionnalit√©s

- **Optimisation automatique** : R√©duction de la taille
- **Suppression des m√©tadonn√©es** : Nettoyage des donn√©es inutiles
- **Nettoyage des valeurs** : Optimisation des attributs num√©riques
- **Conservation du viewBox** : Pr√©servation des dimensions

#### Configuration

```javascript
CONFIG.PLUGINS.SVG = {
  optimize: true,             // Optimisation SVG
  removeMetadata: true,       // Suppression des m√©tadonn√©es
  removeViewBox: false,       // Conservation du viewBox
  cleanupNumericValues: true  // Nettoyage des valeurs num√©riques
}
```

#### Exemple d'utilisation

```javascript
// Dans votre fichier principal
const icon = `{{svg/logo}}`

// Remplace par le contenu optimis√© de src/svg/logo.svg
```

### üìÑ JSON Plugin

**Extension** : `.json`
**Technologie** : JSON.parse/stringify
**Fichier** : `src/plugins/json/index.js`

#### Fonctionnalit√©s

- **Validation de syntaxe** : V√©rification du JSON valide
- **Formatage optionnel** : Indentation personnalisable
- **Minification** : Compression par d√©faut
- **Gestion d'erreurs** : Messages clairs pour JSON invalide

#### Configuration

```javascript
CONFIG.PLUGINS.JSON = {
  prettyPrint: false  // Formatage avec indentation
}
```

#### Exemple d'utilisation

```javascript
// Dans votre fichier principal
const config = `{{json/settings}}`

// Remplace par le contenu valid√© de src/json/settings.json
```

### üñºÔ∏è JPG Plugin

**Extension** : `.jpg`
**Technologie** : Buffer + base64
**Fichier** : `src/plugins/jpg/index.js`

#### Fonctionnalit√©s

- **Conversion base64** : Transformation en cha√Æne encod√©e
- **Types MIME personnalis√©s** : Support de diff√©rents formats
- **Int√©gration directe** : Injection dans le code JavaScript
- **Optimisation** : Compression automatique

#### Configuration

```javascript
CONFIG.PLUGINS.JPG = {
  mimeType: 'image/jpeg',  // Type MIME
  quality: 'original'      // Qualit√© (non utilis√© actuellement)
}
```

#### Exemple d'utilisation

```javascript
// Dans votre fichier principal
const image = `{{jpg/photo}}`

// Remplace par: data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...
```

## Configuration

### Configuration globale

Tous les plugins sont configur√©s dans `src/config/index.js` :

```javascript
export const CONFIG = {
  // Extensions support√©es
  SUPPORTED_EXTENSIONS: ['js', 'css', 'html', 'svg', 'json', 'jpg'],

  // Configuration des plugins
  PLUGINS: {
    JS: { /* options JS */ },
    CSS: { /* options CSS */ },
    HTML: { /* options HTML */ },
    SVG: { /* options SVG */ },
    JSON: { /* options JSON */ },
    JPG: { /* options JPG */ }
  }
}
```

### Personnalisation des options

Vous pouvez modifier les options dans le fichier de configuration :

```javascript
// D√©sactiver la minification CSS
CONFIG.PLUGINS.CSS.minify = false

// Activer le formatage JSON
CONFIG.PLUGINS.JSON.prettyPrint = true

// Ajouter des commentaires de debug JS
CONFIG.PLUGINS.JS.addDebugComments = true
```

## Utilisation des placeholders

### Syntaxe des placeholders

La syntaxe des placeholders suit le pattern : `{{extension/nomFichier}}`

```javascript
// Exemples de placeholders
const css = `{{css/main}}`           // src/css/main.css
const html = `{{html/template}}`     // src/html/template.html
const js = `{{js/utils}}`            // src/js/utils.js
const svg = `{{svg/icon}}`           // src/svg/icon.svg
const json = `{{json/config}}`       // src/json/config.json
const jpg = `{{jpg/image}}`          // src/jpg/image.jpg
```

### R√®gles importantes

1. **Nom de fichier sans extension** : Utilisez seulement le nom, pas l'extension
2. **Extension en minuscules** : Toujours en minuscules dans le placeholder
3. **Sensibilit√© √† la casse** : Respectez la casse exacte des noms de fichiers
4. **Fichiers obligatoires** : Le fichier doit exister dans le r√©pertoire `src/`

### Exemples d'utilisation

#### Exemple complet du boilerplate
```javascript
// Import de tous les types de fichiers
const styles = `{{css/main}}`
const template = `{{html/component}}`
const config = `{{json/settings}}`
const icon = `{{svg/logo}}`
const image = `{{jpg/hero}}`
{{js/utils}}

// Utilisation des donn√©es
const settings = JSON.parse(config)
const container = document.createElement('div')
container.innerHTML = template
container.innerHTML = container.innerHTML
  .replace('{{icon}}', icon)
  .replace('{{image}}', image)
  .replace('{{title}}', settings.title)
  .replace('{{description}}', settings.description)
```

#### Fichier principal (main.js)
```javascript
// Inclusion de styles
const styles = `{{css/main}}`
const styleTag = document.createElement('style')
styleTag.innerHTML = styles
document.head.appendChild(styleTag)

// Inclusion de template HTML
const template = `{{html/header}}`
document.body.insertAdjacentHTML('afterbegin', template)

// Inclusion de modules JavaScript
const utils = `{{js/helper}}`
const api = `{{js/apiClient}}`

// Inclusion d'ic√¥nes SVG
const icon = `{{svg/logo}}`
document.querySelector('.logo').innerHTML = icon

// Inclusion de donn√©es JSON
const config = `{{json/settings}}`
const settings = JSON.parse(config)

// Inclusion d'images
const image = `{{jpg/photo}}`
document.querySelector('.photo').src = image
```

## Cr√©ation de plugins personnalis√©s

### Utilisation de BasePlugin

```javascript
import { BasePlugin } from '../base/BasePlugin.js'

class CustomPlugin extends BasePlugin {
  constructor() {
    super('custom')
  }

  async handle(data, file, fileName, fileExt) {
    return this.execute(async () => {
      // Logique du plugin
      const content = await this.processFile(file)
      return this.replaceContent(data, fileName, fileExt, content)
    }, data, file, fileName, fileExt)
  }

  async processFile(filePath) {
    // Traitement sp√©cifique du fichier
    return processedContent
  }
}
```

### Structure recommand√©e

```javascript
// src/plugins/custom/index.js
import fs from 'node:fs/promises'
import { CONFIG } from '../../config/index.js'
import replaceContent from '../../replace-content.js'
import { PluginError } from '../../errors/CustomError.js'

async function handleCustomFile(data, file, fileName, fileExt) {
  try {
    const response = await getCustomOutput(file)
    return replaceContent(data, fileName, fileExt, response)
  } catch (error) {
    throw new PluginError(`Custom plugin failed for ${file}: ${error.message}`, 'custom', file)
  }
}

async function getCustomOutput(filePath) {
  try {
    const content = await fs.readFile(filePath, 'utf8')

    // Traitement sp√©cifique bas√© sur CONFIG.PLUGINS.CUSTOM
    let processedContent = content

    if (CONFIG.PLUGINS.CUSTOM.option1) {
      processedContent = processWithOption1(processedContent)
    }

    return processedContent
  } catch (error) {
    throw new Error(`Custom processing failed for ${filePath}: ${error.message}`)
  }
}

export { handleCustomFile }
```

### Enregistrement du plugin

```javascript
// src/plugins/index.js
import { handleCustomFile } from './custom/index.js'

const plugins = {
  // ... autres plugins
  custom: handleCustomFile
}
```

## Exemples pratiques

### Projet A/B Testing

```javascript
// variation1.js
let logoraTemplate = `{{html/logora}}`

// Styles CSS
const css = `{{css/main}}`
const styleTag = document.createElement('style')
styleTag.id = 'AB_style'
styleTag.innerHTML = css
document.querySelector('head').insertAdjacentElement('beforeend', styleTag)

// Modules JavaScript
{{js/getFromDatalayer}}
{{js/computeLogoraData}}
{{js/computeResults}}

// Configuration JSON
const config = `{{json/settings}}`
const settings = JSON.parse(config)

// Ic√¥ne SVG
const icon = `{{svg/logo}}`

// Image JPG
const image = `{{jpg/photo}}`
```

### Structure de fichiers

```
project/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.css          # Styles principaux
‚îÇ   ‚îú‚îÄ‚îÄ html/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logora.html       # Template HTML
‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ getFromDatalayer.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ computeLogoraData.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ computeResults.js
‚îÇ   ‚îú‚îÄ‚îÄ svg/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo.svg          # Ic√¥ne SVG
‚îÇ   ‚îú‚îÄ‚îÄ json/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.json     # Configuration
‚îÇ   ‚îî‚îÄ‚îÄ jpg/
‚îÇ       ‚îî‚îÄ‚îÄ photo.jpg         # Image
‚îú‚îÄ‚îÄ variation1.js             # Fichier principal
‚îî‚îÄ‚îÄ dist/
    ‚îî‚îÄ‚îÄ variation1.js         # Fichier g√©n√©r√©
```

### R√©sultat final

Le fichier `dist/variation1.js` contiendra :

```javascript
let logoraTemplate = `<div class="logora">...</div>`

// Styles CSS trait√©s
const css = `.logora{color:#333;font-size:14px}`
const styleTag = document.createElement('style')
styleTag.id = 'AB_style'
styleTag.innerHTML = css
document.querySelector('head').insertAdjacentElement('beforeend', styleTag)

// Modules JavaScript inclus
function getFromDataLayer(key) { /* ... */ }
function computeLogoraData(data) { /* ... */ }
function computeResults(debate, element) { /* ... */ }

// Configuration JSON pars√©e
const config = `{"apiUrl":"https://api.example.com","timeout":5000}`
const settings = JSON.parse(config)

// Ic√¥ne SVG optimis√©e
const icon = `<svg viewBox="0 0 100 100"><path d="..."/></svg>`

// Image JPG en base64
const image = `data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...`
```

## D√©pannage

### Erreurs courantes

#### Plugin non trouv√©
```
Error: Plugin js failed for /path/to/file.js: Plugin not found
```
**Solution** : V√©rifiez que le plugin est enregistr√© dans `src/plugins/index.js`

#### Fichier source manquant
```
Error: JS plugin failed for /path/to/file.js: File not found
```
**Solution** : V√©rifiez que le fichier existe dans le r√©pertoire `src/js/`

#### Placeholder mal form√©
```
Warning: No supported files found in /path/to/src
```
**Solution** : V√©rifiez la syntaxe des placeholders : `{{extension/nomFichier}}`

### Debug des plugins

Activez le mode debug pour plus d'informations :

```bash
# Mode debug avec logs d√©taill√©s
npm run debug <projet>

# Avec variables d'environnement
NODE_ENV=development npm run start <projet>
```

Cela affichera :
- Les fichiers trait√©s par chaque plugin
- Les erreurs d√©taill√©es avec stack traces
- Les statistiques de traitement
